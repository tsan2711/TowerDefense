@startuml Microservice Architecture - Activity Diagram

!theme plain
skinparam activity {
  BackgroundColor #E8F4F8
  BorderColor #2E7D9A
  FontSize 12
}
skinparam activityStartEnd {
  BackgroundColor #FFE6CC
  BorderColor #D79B00
}
skinparam activityDecision {
  BackgroundColor #FFF2CC
  BorderColor #D6B656
}
skinparam partition {
  BackgroundColor #F5F5F5
  BorderColor #999999
}

' ============================================
' Activity 1: Start Game Flow
' ============================================
@startuml StartGameFlow
title Start Game Flow

start

:Initialize ServicesBootstrap;
:Register all microservices;
:Initialize ServiceLocator;

partition "Authentication" {
  if (User authenticated?) then (yes)
    :Get Auth Token;
    :Load User Data from Firestore;
  else (no)
    :Show Login Screen;
    :Wait for user authentication;
    stop
  endif
}

partition "Load Game Data" {
  fork
    :Load Level List;
  fork again
    :Load Agent Configurations;
  fork again
    :Load Tower Data;
  fork again
    :Load Inventory Config;
  end fork
  
  :Wait for all data loaded;
}

partition "Load User Data" {
  fork
    :Load User Inventory;
  fork again
    :Load Level Progress;
  fork again
    :Load Agent Configurations;
  end fork
  
  :Wait for all user data loaded;
}

partition "Filter & Sync" {
  :Filter Inventory by maxLevel;
  :Sync Level Progress;
  :Update maxLevel if needed;
}

:Show Main Menu;
:Game Ready;

stop

@enduml

' ============================================
' Activity 2: Play Level Flow
' ============================================
@startuml PlayLevelFlow
title Play Level Flow

start

:Player selects level;

partition "Load Level Data" {
  :Get levelId from selection;
  :Load Level Library Config;
  :Load User Inventory;
  
  if (Inventory loaded?) then (yes)
    :Get Selected Towers (max 3);
  else (no)
    :Load Inventory from Firestore;
    :Get Selected Towers;
  endif
}

partition "Filter Tower Library" {
  :Get unlocked tower types (based on maxLevel);
  :Get selected tower names from inventory;
  :Load tower prefabs from Resources;
  
  fork
    :Match by towerName;
  fork again
    :Match by MainTower type;
  end fork
  
  :Filter library to only selected + unlocked towers;
  :Build TowerLibrary;
}

partition "Initialize Level" {
  :Load Level Scene;
  :Initialize LevelManager;
  :Set starting currency;
  :Initialize home bases;
  :Set levelState = Intro;
}

if (Has Intro?) then (yes)
  :Show Level Intro;
  :Wait for intro completion;
else (no)
endif

:Change levelState = Building;

partition "Building Phase" {
  :Player can build towers;
  :Filter tower library displayed;
  
  repeat
    :Player places tower;
    :Check currency;
    :Deduct cost;
    :Spawn tower;
  repeat while (Player clicks "Start Wave"?)
  
  :Building Completed;
}

:Change levelState = SpawningEnemies;

partition "Combat Phase" {
  fork
    :Start Wave Manager;
    :Spawn enemies in waves;
  fork again
    :Towers attack enemies;
    :Enemies move to base;
  fork again
    :Update currency gain;
    :Update enemy count;
  end fork
  
  repeat
    :Check game state;
  repeat while (Game not over?)
}

:All enemies spawned;
:Change levelState = AllEnemiesSpawned;

if (All enemies killed?) then (yes)
  :Change levelState = Win;
else (no)
  if (All bases destroyed?) then (yes)
    :Change levelState = Lose;
  else (no)
    :Wait for all enemies killed;
    :Change levelState = Win;
  endif
endif

stop

@enduml

' ============================================
' Activity 3: Complete Level Flow
' ============================================
@startuml CompleteLevelFlow
title Complete Level Flow

start

if (Level state?) then (Win)
  :Calculate stars earned;
  :Get levelId;
  :Get maxLevel;
else (Lose)
  :Stars = 0;
  :Get levelId;
endif

partition "Save Progress" {
  :Save Level Progress to Firestore;
  :Update levelStars dictionary;
  :Update maxLevel if higher;
  :Save to local storage;
}

partition "Unlock Tower" {
  :Get level index;
  
  if (Level index == 0?) then (yes)
    :Unlock Rocket tower;
  else (no)
    if (Level index == 1?) then (yes)
      :Unlock Emp tower;
    else (no)
      if (Level index == 2?) then (yes)
        :Unlock Laser tower;
      else (no)
        :No tower to unlock;
      endif
    endif
  endif
  
  if (Tower to unlock?) then (yes)
    :Get tower prefab by MainTower;
    :Check if user already owns;
    
    if (Already owns?) then (no)
      :Unlock Tower in Inventory;
      :Save to Firestore;
      :Update cached inventory;
    else (yes)
      :Skip unlock;
    endif
  endif
}

partition "Sync Data" {
  :Sync Level Progress to Firestore;
  :Update UserInfo.LevelProgress;
  :Filter Inventory by new maxLevel;
  :Reload Inventory if needed;
}

:Show Level Complete UI;
:Update Level Progress display;

if (Player wants to continue?) then (yes)
  :Return to Level Select;
else (no)
  :Return to Main Menu;
endif

stop

@enduml

' ============================================
' Activity 4: Inventory Management Flow
' ============================================
@startuml InventoryManagementFlow
title Inventory Management Flow

start

:Player opens Inventory UI;

partition "Load Inventory" {
  if (Inventory cached?) then (yes)
    :Get cached inventory;
  else (no)
    :Load Inventory from Firestore;
    :Cache inventory;
  endif
}

:Display owned towers;

partition "Select Towers" {
  :Player selects towers (max 3);
  
  if (Selection valid?) then (yes)
    :Validate selection (max 3);
    :Check tower ownership;
    
    if (All owned?) then (yes)
      :Update selected towers;
      :Save to Firestore;
      :Update cached inventory;
      :Fire OnSelectedTowersChanged event;
    else (no)
      :Show error: Tower not owned;
    endif
  else (no)
    :Show error: Too many towers selected;
  endif
}

partition "Unlock Tower" {
  :Player clicks unlock button;
  :Get tower name;
  
  :Load Inventory Config;
  :Get Tower Config;
  :Check unlock requirements;
  
  if (Requirements met?) then (yes)
    :Check if already owned;
    
    if (Already owned?) then (no)
      :Unlock Tower;
      :Add to inventory;
      :Save to Firestore;
      :Update cached inventory;
      :Fire OnInventoryLoaded event;
    else (yes)
      :Show message: Already owned;
    endif
  else (no)
    :Show unlock requirements;
  endif
}

partition "Filter Inventory" {
  :Get player maxLevel;
  :Get unlocked tower types;
  :Load all tower prefabs;
  :Map towerName to MainTower;
  
  :Check each tower in inventory;
  
  repeat
    :Check if tower type unlocked;
    
    if (Tower locked?) then (yes)
      :Remove from inventory;
      :Deselect if selected;
      :Save to Firestore;
    else (no)
      :Keep tower;
    endif
  repeat while (More towers to check?)
  
  :Reload inventory;
  :Update selected towers;
}

:Update Inventory UI;
:Show updated inventory;

stop

@enduml

' ============================================
' Activity 5: Authentication Flow
' ============================================
@startuml AuthenticationFlow
title Authentication Flow

start

:Player opens game;

if (User authenticated?) then (yes)
  :Get current user;
  :Load cached user data;
  :Continue to main menu;
  stop
else (no)
endif

:Show Login Screen;

if (Login method?) then (Google)
  :Sign In with Google;
  
  partition "Google Sign In" {
    :Initialize Google Sign In;
    :Request authentication;
    :Get Google credentials;
    :Authenticate with Firebase;
  }
  
else (Email/Password)
  if (Action?) then (Sign In)
    :Enter email and password;
    :Sign In with Email/Password;
    
    partition "Email Sign In" {
      :Validate credentials;
      :Authenticate with Firebase;
    }
    
  else (Sign Up)
    :Enter email and password;
    :Sign Up with Email/Password;
    
    partition "Email Sign Up" {
      :Validate email format;
      :Validate password strength;
      :Create new account;
      :Authenticate with Firebase;
    }
  endif
endif

partition "Post Authentication" {
  :Get Auth Token;
  :Get User Info;
  :Save User Data to Firestore;
  :Load User Data;
  :Load User Inventory;
  :Initialize Inventory if new user;
  :Load Level Progress;
}

if (Authentication successful?) then (yes)
  :Fire OnSignInSuccess event;
  :Update UI with user info;
  :Navigate to Main Menu;
else (no)
  :Fire OnSignInFailed event;
  :Show error message;
  :Return to Login Screen;
endif

stop

@enduml

' ============================================
' Activity 6: Filter Tower Library Flow
' ============================================
@startuml FilterTowerLibraryFlow
title Filter Tower Library Flow

start

:Level starts;
:Get current levelId;

partition "Load Data" {
  :Load TowerLibraryContainer;
  :Get TowerLibrary for levelId;
  :Get player maxLevel;
  :Load User Inventory;
}

partition "Get Unlocked Types" {
  :Initialize unlocked types set;
  :Add MachineGun (always unlocked);
  
  if (maxLevel >= 2?) then (yes)
    :Add Rocket;
  endif
  
  if (maxLevel >= 3?) then (yes)
    :Add Emp;
  endif
  
  if (maxLevel >= 4?) then (yes)
    :Add Laser;
  endif
}

partition "Get Selected Towers" {
  :Get inventory data;
  :Get selected towers (isSelected = true);
  :Create selected tower names set;
  :Create towerName to towerType mapping;
}

partition "Load Source Towers" {
  :Load towers from existing library;
  :Load tower prefabs from Resources/Towers;
  :Create source towers dictionary;
  :Merge and deduplicate;
}

partition "Match & Filter" {
  :Initialize matched inventory towers set;
  
  repeat
    :Get next tower prefab;
    
    :Check if MainTower unlocked;
    
    if (Unlocked?) then (yes)
      :Try match by towerName;
      
      if (Name match found?) then (yes)
        if (Already matched?) then (no)
          :Mark as selected;
          :Add to matched set;
        else (yes)
          :Skip duplicate;
        endif
      else (no)
        :Try match by MainTower type;
        
        if (Type match found?) then (yes)
          if (Already matched?) then (no)
            :Mark as selected;
            :Add to matched set;
          else (yes)
            :Skip duplicate;
          endif
        endif
      endif
      
      if (Selected and unlocked?) then (yes)
        :Add to filtered library;
      endif
    else (no)
      :Skip locked tower;
    endif
  repeat while (More prefabs to check?)
}

:Check if all selected towers matched;

if (All matched?) then (yes)
  :Log success;
else (no)
  :Log warning: Some towers not matched;
endif

:Rebuild TowerLibrary dictionary;
:Fire towerLibraryUpdated event;
:Level ready with filtered towers;

stop

@enduml


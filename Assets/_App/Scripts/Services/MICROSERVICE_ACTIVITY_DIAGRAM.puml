@startuml Tower Defense - Activity Diagrams

!theme plain

skinparam activity {
  BackgroundColor #E8F4F8
  BorderColor #2E7D9A
  FontSize 11
}
skinparam activityStartEnd {
  BackgroundColor #FFE6CC
  BorderColor #D79B00
  FontSize 11
}
skinparam activityDecision {
  BackgroundColor #FFF2CC
  BorderColor #D6B656
  FontSize 10
}
skinparam partition {
  BackgroundColor #F5F5F5
  BorderColor #999999
  FontSize 12
  FontStyle bold
}
skinparam note {
  BackgroundColor #FFF9E6
  BorderColor #D6B656
  FontSize 10
}

' ============================================
' ACTIVITY 1: Game Startup Flow
' ============================================
title üéÆ Game Startup Flow

start

partition "Service Initialization" {
  :Initialize ServicesBootstrap;
  :Register all services to ServiceLocator;
  note right
    Services:
    - AuthService
    - UserDataService
    - InventoryService
    - LevelManagementService
    - TowerDataService
  end note
}

partition "Authentication Check" {
  if (User authenticated?) then (yes)
    :Get current user;
    :Retrieve auth token;
  else (no)
    :Show Login Screen;
    stop
  endif
}

partition "Load Game Configuration" {
  fork
    :Load Level List;
  fork again
    :Load Tower Data;
  fork again
    :Load Inventory Config;
  fork again
    :Load Agent Config;
  end fork
}

partition "Load User Data" {
  fork
    :Load User Profile;
  fork again
    :Load Level Progress;
  fork again
    :Load User Inventory;
  end fork
}

partition "Sync & Filter" {
  :Filter inventory by maxLevel;
  :Sync progress to cloud;
}

:Show Main Menu;

stop

' ============================================
' ACTIVITY 2: Play Level Flow
' ============================================
newpage

title üéØ Play Level Flow

start

:Player selects level;

partition "Level Preparation" {
  :Get levelId;
  :Check level unlock status;
  
  if (Level unlocked?) then (yes)
    :Load Level Config;
  else (no)
    :Show locked message;
    stop
  endif
}

partition "Load Inventory" {
  :Get selected towers (max 3);
  :Get unlocked tower types by maxLevel;
  
  note right
    Unlock Rules:
    - MachineGun: Always unlocked
    - Rocket: maxLevel >= 2
    - Emp: maxLevel >= 3
    - Laser: maxLevel >= 4
  end note
}

partition "Build Tower Library" {
  :Load tower prefabs;
  :Filter by selected & unlocked;
  :Create Tower Library;
}

partition "Initialize Level" {
  :Load Level Scene;
  :Initialize LevelManager;
  :Set starting currency;
  :Set level state = Building;
}

partition "Building Phase" {
  repeat
    :Player places tower;
    
    if (Enough currency?) then (yes)
      :Deduct cost;
      :Spawn tower;
    else (no)
      :Show insufficient funds;
    endif
    
  repeat while (Start wave?) is (no)
  ->yes;
}

:Set level state = Combat;

partition "Combat Phase" {
  fork
    :Spawn enemy waves;
  fork again
    :Towers auto-attack;
  fork again
    :Track enemy count;
  end fork
  
  repeat
    if (All bases destroyed?) then (yes)
      :Level state = Lose;
      stop
    endif
  repeat while (Enemies remaining?) is (yes)
  ->no;
}

if (All enemies defeated?) then (yes)
  :Level state = Win;
  :Calculate stars (1-3);
else (no)
  :Level state = Lose;
  :Stars = 0;
endif

:Complete Level;

stop

' ============================================
' ACTIVITY 3: Complete Level Flow
' ============================================
newpage

title üèÜ Complete Level Flow

start

:Get level result (Win/Lose);

if (Result?) then (Win)
  :Calculate stars (1-3);
  :Get level rewards;
else (Lose)
  :Stars = 0;
  :No rewards;
endif

partition "Save Progress" {
  :Save level stars to Firestore;
  :Update maxLevel if higher;
  :Update local cache;
  
  note right
    Progress saved to:
    users/{uid}/levelProgress
  end note
}

partition "Unlock Rewards" {
  if (Level completed first time?) then (yes)
    :Check unlock requirements;
    
    switch (Level index?)
    case (0)
      :Unlock Rocket Tower;
    case (1)
      :Unlock Emp Tower;
    case (2)
      :Unlock Laser Tower;
    case (else)
      :No tower unlock;
    endswitch
    
    if (Tower unlocked?) then (yes)
      :Add to inventory;
      :Save to Firestore;
      :Show unlock notification;
    endif
  else (no)
    :Skip unlock;
  endif
}

partition "Sync & Update" {
  :Sync progress to cloud;
  :Filter inventory by new maxLevel;
  :Reload available towers;
  :Fire completion events;
}

:Show Level Complete Screen;
:Display stars & rewards;

if (Next action?) then (Retry)
  :Restart level;
else (Continue)
  :Return to Level Select;
endif

stop

' ============================================
' ACTIVITY 4: Inventory Management Flow
' ============================================
newpage

title üéí Inventory Management Flow

start

:Player opens Inventory UI;

partition "Load Inventory" {
  if (Inventory cached?) then (yes)
    :Use cached data;
  else (no)
    :Load from Firestore;
    :Cache inventory;
  endif
}

:Display owned towers;

partition "Select Towers" {
  :Player selects/deselects towers;
  
  if (Selection count <= 3?) then (valid)
    :Update selection;
    :Save to Firestore;
    :Fire OnSelectedTowersChanged event;
    
    note right
      Max 3 towers
      can be selected
    end note
  else (invalid)
    :Show error: Max 3 towers;
  endif
}

partition "Unlock Tower (Optional)" {
  if (Player clicks unlock?) then (yes)
    :Get tower config;
    :Check unlock requirements;
    
    if (Requirements met?) then (yes)
      if (Already owned?) then (no)
        :Add to inventory;
        :Save to Firestore;
        :Show unlock success;
      else (yes)
        :Already owned message;
      endif
    else (no)
      :Show requirements;
    endif
  endif
}

:Update Inventory UI;

stop

' ============================================
' ACTIVITY 5: Authentication Flow
' ============================================
newpage

title üîê Authentication Flow

start

:Player opens game;

if (Already authenticated?) then (yes)
  :Get current user;
  :Continue to main menu;
  stop
endif

:Show Login Screen;

partition "Choose Auth Method" {
  if (Login method?) then (Google)
    :Click Google Sign In;
    :Open Google Auth;
    :Select Google account;
    :Get Google credentials;
    
  else (Email)
    if (Action?) then (Sign In)
      :Enter email & password;
      :Validate credentials;
      
    else (Sign Up)
      :Enter email & password;
      :Validate email format;
      :Validate password strength;
      :Create new account;
    endif
  endif
}

partition "Firebase Authentication" {
  :Authenticate with Firebase;
  
  if (Auth successful?) then (yes)
    :Get Auth Token;
    :Get User Info (uid, email);
  else (no)
    :Show error message;
    :Return to Login Screen;
    stop
  endif
}

partition "Initialize User Data" {
  if (New user?) then (yes)
    :Create user document in Firestore;
    :Initialize default inventory;
    :Set maxLevel = 1;
  else (no)
    :Load existing user data;
  endif
  
  :Load user inventory;
  :Load level progress;
  :Cache user data;
}

:Fire OnSignInSuccess event;
:Navigate to Main Menu;

stop

' ============================================
' ACTIVITY 6: Tower Library Filtering
' ============================================
newpage

title üóº Tower Library Filtering

start

:Level starts;
:Get levelId;

partition "Load Required Data" {
  fork
    :Load TowerLibrary for level;
  fork again
    :Get player maxLevel;
  fork again
    :Get selected towers from inventory;
  end fork
}

partition "Determine Unlocked Types" {
  :Create unlocked types set;
  :Add MachineGun (always);
  
  if (maxLevel >= 2?) then (yes)
    :Add Rocket;
  endif
  
  if (maxLevel >= 3?) then (yes)
    :Add Emp;
  endif
  
  if (maxLevel >= 4?) then (yes)
    :Add Laser;
  endif
  
  note right
    Progressive unlock system
    based on player level
  end note
}

partition "Filter & Match" {
  :Load tower prefabs from Resources;
  :Get selected tower names;
  
  repeat
    :Get next tower prefab;
    
    if (Tower type unlocked?) then (yes)
      if (Tower in selection?) then (yes)
        :Add to filtered library;
      else (no)
        :Skip;
      endif
    else (no)
      :Skip locked tower;
    endif
    
  repeat while (More towers?) is (yes)
  ->no;
}

partition "Validate & Finalize" {
  if (All selected matched?) then (yes)
    :Log success;
  else (no)
    :Log warning;
  endif
  
  :Build final TowerLibrary;
  :Fire towerLibraryUpdated event;
}

:Level ready with towers;

stop

@enduml

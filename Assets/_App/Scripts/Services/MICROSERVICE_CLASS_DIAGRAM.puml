@startuml Tower Defense - Class Diagram

!theme plain

skinparam class {
  BackgroundColor #E8F4F8
  BorderColor #2E7D9A
  ArrowColor #2E7D9A
  FontSize 10
}

skinparam interface {
  BackgroundColor #FFF2CC
  BorderColor #D6B656
  FontSize 10
}

skinparam abstract {
  BackgroundColor #E8F5E9
  BorderColor #4CAF50
}

skinparam classAttributeIconSize 0
skinparam shadowing false
skinparam linetype ortho
skinparam packageStyle rectangle
skinparam maxMessageSize 60
skinparam packagePadding 10
skinparam defaultFontSize 10

' ============================================
' LAYER 1: CORE INTERFACES
' ============================================
package "Core Layer" #FAFAFA {
  
  interface IService {
    +Initialize() : void
    +IsInitialized : bool
    +Shutdown() : void
  }
  
  abstract class FirestoreServiceBase {
    #firestore : FirebaseFirestore
    #isInitialized : bool
    +Initialize() : void
    +Shutdown() : void
    #InitializeFirestoreInstance() : void
    #GetServiceName() : string
  }
  
  FirestoreServiceBase ..|> IService
}

' ============================================
' LAYER 2: DOMAIN SERVICES
' ============================================

' Authentication Domain
package "üîê Authentication" #FFF9E6 {
  
  interface IAuthService {
    +SignInWithGoogleAsync() : Task<AuthResult>
    +SignInWithEmailAsync(email, password) : Task<AuthResult>
    +SignUpAsync(email, password) : Task<AuthResult>
    +SignOutAsync() : Task
    +IsAuthenticated : bool
    +CurrentUser : UserInfo
    +GetAuthTokenAsync() : Task<string>
    +OnSignInSuccess : event
    +OnSignInFailed : event
    +OnSignOut : event
  }
  
  class FirebaseAuthService {
    -auth : FirebaseAuth
    -currentUser : UserInfo
    +SignInWithGoogleAsync() : Task<AuthResult>
    +SignInWithEmailAsync(email, password) : Task<AuthResult>
    +SignUpAsync(email, password) : Task<AuthResult>
    +SignOutAsync() : Task
    +IsAuthenticated : bool
    +CurrentUser : UserInfo
    +GetAuthTokenAsync() : Task<string>
    -HandleAuthResult(result) : void
  }
  
  IAuthService <|.. FirebaseAuthService
}

' User Management Domain
package "üë§ User Management" #E8F5F9 {
  
  interface IUserDataService {
    +SaveUserDataAsync(uid, data) : Task<bool>
    +LoadUserDataAsync(uid) : Task<UserData>
    +SaveLevelProgressAsync(uid, levelId, stars, maxLevel) : Task<bool>
    +LoadLevelProgressAsync(uid) : Task<LevelProgress>
    +SyncProgressAsync(uid) : Task<bool>
    +GetCachedUserData() : UserData
    +OnUserDataLoaded : event
  }
  
  class UserDataService {
    -cachedUserData : UserData
    +SaveUserDataAsync(uid, data) : Task<bool>
    +LoadUserDataAsync(uid) : Task<UserData>
    +SaveLevelProgressAsync(uid, levelId, stars, maxLevel) : Task<bool>
    +LoadLevelProgressAsync(uid) : Task<LevelProgress>
    +SyncProgressAsync(uid) : Task<bool>
    +GetCachedUserData() : UserData
    #GetServiceName() : string
  }
  
  class UserData {
    +uid : string
    +email : string
    +displayName : string
    +maxLevel : int
    +levelProgress : Dictionary<int, int>
    +createdAt : DateTime
    +lastLoginAt : DateTime
  }
  
  IUserDataService <|.. UserDataService
  FirestoreServiceBase <|-- UserDataService
  UserDataService "1" *-- "1" UserData : manages
}

' Inventory Domain
package "üéí Inventory" #F3E5F5 {
  
  interface IInventoryService {
    +LoadUserInventoryAsync(uid) : Task<TowerInventoryData>
    +UnlockTowerAsync(uid, towerName) : Task<bool>
    +SelectTowersAsync(uid, towerNames) : Task<bool>
    +RemoveTowerAsync(uid, towerName) : Task<bool>
    +GetCachedInventory() : TowerInventoryData
    +HasTower(towerName) : bool
    +GetSelectedTowers() : List<string>
    +OnInventoryLoaded : event
    +OnSelectedTowersChanged : event
    +OnTowerUnlocked : event
  }
  
  class InventoryService {
    -cachedInventory : TowerInventoryData
    +LoadUserInventoryAsync(uid) : Task<TowerInventoryData>
    +UnlockTowerAsync(uid, towerName) : Task<bool>
    +SelectTowersAsync(uid, towerNames) : Task<bool>
    +RemoveTowerAsync(uid, towerName) : Task<bool>
    +GetCachedInventory() : TowerInventoryData
    +HasTower(towerName) : bool
    +GetSelectedTowers() : List<string>
    -ValidateSelection(towerNames) : bool
    #GetServiceName() : string
  }
  
  interface IInventoryConfigService {
    +LoadInventoryConfigAsync() : Task<Dictionary>
    +GetTowerConfig(towerName) : InventoryConfigData
    +CanUnlockTower(towerName, level, currency) : bool
    +CheckUnlockRequirements(towerName, userLevel) : bool
    +OnInventoryConfigLoaded : event
  }
  
  class InventoryConfigService {
    -configCache : Dictionary<string, InventoryConfigData>
    +LoadInventoryConfigAsync() : Task<Dictionary>
    +GetTowerConfig(towerName) : InventoryConfigData
    +CanUnlockTower(towerName, level, currency) : bool
    +CheckUnlockRequirements(towerName, userLevel) : bool
    #GetServiceName() : string
  }
  
  class TowerInventoryData {
    +ownedTowers : List<InventoryItemData>
    +selectedTowers : List<string>
    +maxSelectionCount : int
  }
  
  class InventoryItemData {
    +towerName : string
    +isOwned : bool
    +isSelected : bool
    +unlockedAt : DateTime
  }
  
  class InventoryConfigData {
    +towerName : string
    +unlockLevel : int
    +unlockCost : int
    +description : string
  }
  
  IInventoryService <|.. InventoryService
  IInventoryConfigService <|.. InventoryConfigService
  FirestoreServiceBase <|-- InventoryService
  FirestoreServiceBase <|-- InventoryConfigService
  InventoryService "1" *-- "1" TowerInventoryData : manages
  TowerInventoryData "1" *-- "*" InventoryItemData : contains
}

' Level Management Domain
package "üó∫Ô∏è Level Management" #E8F5E9 {
  
  interface ILevelManagementService {
    +LoadLevelListAsync() : Task<LevelList>
    +LoadLevelLibraryConfigAsync(levelId) : Task<LevelLibraryConfig>
    +GetLevelById(levelId) : LevelData
    +IsLevelUnlocked(levelId, maxLevel) : bool
    +OnLevelListLoaded : event
  }
  
  class LevelManagementService {
    -levelListCache : LevelList
    +LoadLevelListAsync() : Task<LevelList>
    +LoadLevelLibraryConfigAsync(levelId) : Task<LevelLibraryConfig>
    +GetLevelById(levelId) : LevelData
    +IsLevelUnlocked(levelId, maxLevel) : bool
    #GetServiceName() : string
  }
  
  class LevelList {
    +levels : List<LevelData>
  }
  
  class LevelData {
    +levelId : int
    +levelName : string
    +sceneName : string
    +requiredLevel : int
    +difficulty : int
  }
  
  class LevelLibraryConfig {
    +levelId : int
    +availableTowers : List<string>
    +enemyWaves : List<WaveConfig>
  }
  
  ILevelManagementService <|.. LevelManagementService
  FirestoreServiceBase <|-- LevelManagementService
  LevelManagementService "1" *-- "1" LevelList : manages
  LevelList "1" *-- "*" LevelData : contains
}

' Tower & Agent Domain
package "üóº Tower & Agent" #FFF3E0 {
  
  interface ITowerDataService {
    +LoadTowerDataAsync() : Task<Dictionary>
    +GetTowerData(towerName) : TowerData
    +FilterByType(towerType) : List<TowerData>
    +OnTowerDataLoaded : event
  }
  
  class TowerDataService {
    -towerDataCache : Dictionary<string, TowerData>
    +LoadTowerDataAsync() : Task<Dictionary>
    +GetTowerData(towerName) : TowerData
    +FilterByType(towerType) : List<TowerData>
    #GetServiceName() : string
  }
  
  class TowerData {
    +towerName : string
    +towerType : MainTower
    +damage : int
    +range : float
    +fireRate : float
    +cost : int
  }
  
  interface IAgentConfigurationService {
    +LoadAgentConfigurationsAsync() : Task<Dictionary>
    +GetAgentConfig(agentName) : AgentConfig
    +FilterByType(agentType) : List<AgentConfig>
    +OnAgentConfigLoaded : event
  }
  
  class AgentConfigurationService {
    -agentConfigCache : Dictionary<string, AgentConfig>
    +LoadAgentConfigurationsAsync() : Task<Dictionary>
    +GetAgentConfig(agentName) : AgentConfig
    +FilterByType(agentType) : List<AgentConfig>
    #GetServiceName() : string
  }
  
  class AgentConfig {
    +agentName : string
    +agentType : string
    +health : int
    +speed : float
    +reward : int
  }
  
  ITowerDataService <|.. TowerDataService
  IAgentConfigurationService <|.. AgentConfigurationService
  FirestoreServiceBase <|-- TowerDataService
  FirestoreServiceBase <|-- AgentConfigurationService
}

' ============================================
' LAYER 3: SERVICE INFRASTRUCTURE
' ============================================
package "‚öôÔ∏è Service Infrastructure" #ECEFF1 {
  
  class ServiceLocator {
    -instance : ServiceLocator
    -services : Dictionary<Type, IService>
    +{static} Instance : ServiceLocator
    +RegisterService<T>(service : T) : void
    +GetService<T>() : T
    +UnregisterService<T>() : void
    +IsServiceRegistered<T>() : bool
    +InitializeAllServices() : void
    +ShutdownAllServices() : void
  }
  
  class ServicesBootstrap {
    -autoInitializeOnAwake : bool
    +InitializeServices() : void
    -RegisterAllServices() : void
    -InitializeAuthService() : void
    -InitializeUserDataService() : void
    -InitializeInventoryService() : void
    -InitializeInventoryConfigService() : void
    -InitializeLevelManagementService() : void
    -InitializeTowerDataService() : void
    -InitializeAgentConfigService() : void
  }
  
  ServiceLocator o-- IService : manages
  ServicesBootstrap ..> ServiceLocator : registers to
}

' ============================================
' LAYER 4: GAME LOGIC (CONSUMERS)
' ============================================
package "üéÆ Game Controllers" #E3F2FD {
  
  class GameManager {
    -authService : IAuthService
    -userDataService : IUserDataService
    -inventoryService : IInventoryService
    -levelService : ILevelManagementService
    +Initialize() : void
    +StartGame() : void
    +LoadPlayerData() : Task
    +CompleteLevel(levelId, stars) : void
    +GetMaxLevel() : int
    +OnGameReady : event
  }
  
  class LevelManager {
    -inventoryService : IInventoryService
    -towerDataService : ITowerDataService
    -levelLibrary : LevelLibraryConfig
    -towerLibrary : TowerLibrary
    -levelState : LevelState
    -currency : Currency
    +InitializeLevel(levelId) : Task
    +StartLevel() : void
    +BuildTower(towerName, position) : bool
    +UpgradeTower(tower) : bool
    +SellTower(tower) : bool
    +CompleteLevel(isWin) : void
    -FilterTowerLibrary() : void
  }
  
  class TowerLibrary {
    +availableTowers : Dictionary<string, TowerPrefab>
    +AddTower(towerName, prefab) : void
    +GetTower(towerName) : TowerPrefab
    +FilterBySelected(selectedTowers) : void
  }
  
  enum LevelState {
    Intro
    Building
    SpawningEnemies
    AllEnemiesSpawned
    Win
    Lose
  }
  
  LevelManager "1" *-- "1" TowerLibrary : uses
  LevelManager "1" -- "1" LevelState : has
}

' ============================================
' CROSS-PACKAGE RELATIONSHIPS
' ============================================

' Game Manager Dependencies
GameManager ..> IAuthService : uses
GameManager ..> IUserDataService : uses
GameManager ..> IInventoryService : uses
GameManager ..> ILevelManagementService : uses

' Level Manager Dependencies
LevelManager ..> IInventoryService : uses
LevelManager ..> ITowerDataService : uses
LevelManager ..> ILevelManagementService : uses

' ============================================
' NOTES
' ============================================

note top of ServiceLocator
  **Service Locator Pattern**
  - Central registry for all services
  - Singleton implementation
  - Supports service lifecycle management
end note

note top of FirestoreServiceBase
  **Abstract Base Class**
  - Shared Firestore initialization
  - Common error handling
  - Template method pattern
end note

note bottom of GameManager
  **Main Game Controller**
  - Orchestrates game flow
  - Manages player session
  - Coordinates all services
end note

note bottom of InventoryService
  **Max 3 Tower Selection Rule**
  Enforces game rule limiting
  player to select maximum of
  3 towers per level
end note

@enduml

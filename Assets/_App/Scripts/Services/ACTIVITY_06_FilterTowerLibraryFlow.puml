@startuml Filter Tower Library Flow

!theme plain
skinparam activity {
  BackgroundColor #E8F4F8
  BorderColor #2E7D9A
  FontSize 12
}
skinparam activityStartEnd {
  BackgroundColor #FFE6CC
  BorderColor #D79B00
  FontSize 12
}
skinparam activityDecision {
  BackgroundColor #FFF2CC
  BorderColor #D6B656
  FontSize 11
}
skinparam partition {
  BackgroundColor #F5F5F5
  BorderColor #999999
  FontSize 12
}

start

:Level starts;
:Get current levelId;

partition "Load Data" {
  :Load TowerLibraryContainer;
  :Get TowerLibrary for levelId;
  :Get player maxLevel;
  :Load User Inventory;
}

partition "Get Unlocked Types" {
  :Initialize unlocked types set;
  :Add MachineGun\n(always unlocked);
  
  if (maxLevel >= 2?) then (yes)
    :Add Rocket;
  endif
  
  if (maxLevel >= 3?) then (yes)
    :Add Emp;
  endif
  
  if (maxLevel >= 4?) then (yes)
    :Add Laser;
  endif
}

partition "Get Selected Towers" {
  :Get inventory data;
  :Get selected towers\n(isSelected = true);
  :Create selected tower names set;
  :Create towerName to\ntowerType mapping;
}

partition "Load Source Towers" {
  :Load towers from\nexisting library;
  :Load tower prefabs\nfrom Resources/Towers;
  :Create source towers dictionary;
  :Merge and deduplicate;
}

partition "Match & Filter" {
  :Initialize matched\ninventory towers set;
  
  repeat
    :Get next tower prefab;
    
    :Check if MainTower unlocked;
    
    if (Unlocked?) then (yes)
      :Try match by towerName;
      
      if (Name match found?) then (yes)
        if (Already matched?) then (no)
          :Mark as selected;
          :Add to matched set;
        else (yes)
          :Skip duplicate;
        endif
      else (no)
        :Try match by MainTower type;
        
        if (Type match found?) then (yes)
          if (Already matched?) then (no)
            :Mark as selected;
            :Add to matched set;
          else (yes)
            :Skip duplicate;
          endif
        endif
      endif
      
      if (Selected and unlocked?) then (yes)
        :Add to filtered library;
      endif
    else (no)
      :Skip locked tower;
    endif
  repeat while (More prefabs to check?)
}

:Check if all selected\ntowers matched;

if (All matched?) then (yes)
  :Log success;
else (no)
  :Log warning:\nSome towers not matched;
endif

:Rebuild TowerLibrary dictionary;
:Fire towerLibraryUpdated event;
:Level ready with filtered towers;

stop

@enduml




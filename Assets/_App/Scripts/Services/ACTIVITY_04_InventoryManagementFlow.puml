@startuml Inventory Management Flow

!theme plain
skinparam activity {
  BackgroundColor #E8F4F8
  BorderColor #2E7D9A
  FontSize 12
}
skinparam activityStartEnd {
  BackgroundColor #FFE6CC
  BorderColor #D79B00
  FontSize 12
}
skinparam activityDecision {
  BackgroundColor #FFF2CC
  BorderColor #D6B656
  FontSize 11
}
skinparam partition {
  BackgroundColor #F5F5F5
  BorderColor #999999
  FontSize 12
}

start

:Player opens Inventory UI;

partition "Load Inventory" {
  if (Inventory cached?) then (yes)
    :Get cached inventory;
  else (no)
    :Load Inventory from Firestore;
    :Cache inventory;
  endif
}

:Display owned towers;

partition "Select Towers" {
  :Player selects towers\n(max 3);
  
  if (Selection valid?) then (yes)
    :Validate selection (max 3);
    :Check tower ownership;
    
    if (All owned?) then (yes)
      :Update selected towers;
      :Save to Firestore;
      :Update cached inventory;
      :Fire OnSelectedTowersChanged event;
    else (no)
      :Show error:\nTower not owned;
    endif
  else (no)
    :Show error:\nToo many towers selected;
  endif
}

partition "Unlock Tower" {
  :Player clicks unlock button;
  :Get tower name;
  
  :Load Inventory Config;
  :Get Tower Config;
  :Check unlock requirements;
  
  if (Requirements met?) then (yes)
    :Check if already owned;
    
    if (Already owned?) then (no)
      :Unlock Tower;
      :Add to inventory;
      :Save to Firestore;
      :Update cached inventory;
      :Fire OnInventoryLoaded event;
    else (yes)
      :Show message:\nAlready owned;
    endif
  else (no)
    :Show unlock requirements;
  endif
}

partition "Filter Inventory" {
  :Get player maxLevel;
  :Get unlocked tower types;
  :Load all tower prefabs;
  :Map towerName to MainTower;
  
  :Check each tower in inventory;
  
  repeat
    :Check if tower type unlocked;
    
    if (Tower locked?) then (yes)
      :Remove from inventory;
      :Deselect if selected;
      :Save to Firestore;
    else (no)
      :Keep tower;
    endif
  repeat while (More towers to check?)
  
  :Reload inventory;
  :Update selected towers;
}

:Update Inventory UI;
:Show updated inventory;

stop

@enduml



